# CD Pipeline - Deploy to EKS
# Triggered on: CI Pipeline completion (only if successful)

name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types: [completed]

jobs:
  deploy-to-eks:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Authenticate with AWS
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # Configure kubectl to access EKS cluster
      - name: Configure kubectl for EKS
        run: |
          aws eks update-kubeconfig \
            --name unleash-exercise-cluster \
            --region ${{ secrets.AWS_REGION }}

      # Get dynamic values from AWS and update manifests
      - name: Update Kubernetes manifests
        run: |
          # Get IAM role ARN for IRSA
          ROLE_ARN="$(aws iam get-role \
            --role-name unleash-exercise-cluster-app-role \
            --query 'Role.Arn' \
            --output text)"

          # Get S3 bucket name
          S3_BUCKET="$(aws s3api list-buckets \
            --query 'Buckets[?starts_with(Name, `unleash-exercise-bucket`)].Name' \
            --output text)"

          # Update ServiceAccount with correct role ARN
          sed -i "s|eks.amazonaws.com/role-arn:.*|eks.amazonaws.com/role-arn: $ROLE_ARN|" k8s/serviceaccount.yaml

          # Update deployment with correct S3 bucket name
          sed -i "s|value: \"unleash-exercise-bucket-.*\"|value: \"$S3_BUCKET\"|" k8s/deployment.yaml

          echo "Updated manifests:"
          echo "  Role ARN: $ROLE_ARN"
          echo "  S3 Bucket: $S3_BUCKET"

      - name: Apply Kubernetes manifests
        run: kubectl apply -f k8s/

      # Wait for rolling update to complete
      - name: Wait for deployment rollout
        run: kubectl rollout status deployment/app

      # Display LoadBalancer endpoint and test URL
      - name: Get LoadBalancer endpoint
        run: |
          echo "Deployment complete!"
          # Get the LoadBalancer URL
          LB_URL=$(kubectl get svc app-service -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')

          echo "Service details:"
          kubectl get svc app-service
          echo ""

          if [ -n "$LB_URL" ]; then
            echo "Test the application:"
            echo "  http://$LB_URL/check-file?fileName=test.txt"
          else
            echo "Note: LoadBalancer URL is still being provisioned."
            echo "Run 'kubectl get svc app-service' to check status."
          fi