# CD Pipeline - Deploy to EKS
# Triggered on: CI Pipeline completion (only if successful)

name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types: [completed]

jobs:
  deploy-to-eks:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Authenticate with AWS
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # Configure kubectl to access EKS cluster
      - name: Configure kubectl for EKS
        run: |
          aws eks update-kubeconfig \
            --name unleash-exercise-cluster \
            --region ${{ secrets.AWS_REGION }}

      # Get ECR image URI and update deployment manifest
      - name: Update deployment image
        run: |
          IMAGE_URI="$(aws ecr describe-repositories \
            --repository-names unleash-exercise-repo \
            --query 'repositories[0].repositoryUri' \
            --output text):latest"

          sed -i "s|image:.*|image: $IMAGE_URI|" k8s/deployment.yaml
          echo "Updated deployment to use image: $IMAGE_URI"

      - name: Apply Kubernetes manifests
        run: kubectl apply -f k8s/

      # Wait for rolling update to complete
      - name: Wait for deployment rollout
        run: kubectl rollout status deployment/app

      # Display LoadBalancer endpoint
      - name: Get LoadBalancer endpoint
        run: |
          echo "Deployment complete! Service details:"
          kubectl get svc app-service
          echo ""
          echo "Note: LoadBalancer may take 2-3 minutes to become active"
